

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>GCC Inline Assembly &mdash; Programming Notes v0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="TODO" href="todo.html" />
    <link rel="prev" title="Qemu" href="qemu.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Programming Notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../sphinx/index.html">Sphinx</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/install.html">Environment Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/useful_extensions.html">Useful Extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/useful_extensions.html#sphinx-ext-extlinks">sphinx.ext.extlinks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/useful_extensions.html#sphinx-ext-napoleon">sphinx.ext.napoleon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/useful_extensions.html#sphinx-ext-todo">sphinx.ext.todo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/useful_extensions.html#sphinx-ext-autodoc">sphinx.ext.autodoc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/open-sources.html">Open Sources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/open-sources.html#virtualenv">virtualenv</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/rst_basics.html">reStructuredText Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/rst_basics.html#references">References</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/rst_basics.html#footnotes">Footnotes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/exhale.html">Exhale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/exhale.html#install-exhale">Install Exhale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/exhale.html#configure-sphinx">Configure Sphinx</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../example_exhale_api/library_root.html">Library API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/index.html">Secure Shell (SSH)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ssh/config.html">Passwordless Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#generate-keys">Generate keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#copy-keys">Copy Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#edit-ssh-config">Edit .ssh/config</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../ssh/config.html#configuration-for-git">Configuration for Git</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#useful-options">Useful Options</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../os/index.html">Operating Systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../os/papers.html">Papers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pybind/index.html">pybind11</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../pybind/install.html">Install pybind11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pybind/make.html">Build with Make</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pybind/setup.html">Build with setup.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pybind/bazel.html">Build with Bazel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pybind/cmake.html">Build with CMake</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../pybind/cmake.html#install-cmake">Install CMake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pybind/cmake.html#build-example">Build Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cmake/index.html">CMake</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cmake/basics.html">Basics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../python/venv.html">Virtual Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python/style_guide.html">Python Style Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../python/style_guide.html#faqs">FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../python/the_with_statement.html">The <code class="docutils literal notranslate"><span class="pre">with</span></code> Statement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../python/the_with_statement.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../python/decorators.html">Decorators</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../python/decorators.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../bash/index.html">Bash</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../bash/basics.html">Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../bash/basics.html#get-the-current-directory-of-the-script">Get the current directory of the script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bash/basics.html#date"><code class="docutils literal notranslate"><span class="pre">date</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../bash/basics.html#array"><code class="docutils literal notranslate"><span class="pre">array</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../bash/basics.html#block-comment">Block Comment</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pytorch/index.html">PyTorch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../pytorch/open-source.html">Open Source Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../kaldi/index.html">Kaldi</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../kaldi/transition_model.html">Transition Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../kaldi/transition_model.html#basic-terminology">Basic Terminology</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../git/index.html">Git</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../git/submodule.html">Submodules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cpp/index.html">C++ Programming</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cpp/cppcon.html">CppCon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpp/perf.html">Linux Perf tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpp/templates/index.html">Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cpp/templates/type_traits.html">Type Traits</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/templates/type_traits.html#header-files">Header Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../cpp/templates/type_traits.html#papers">Papers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../cpp/templates/type_traits.html#add-rvalue-reference">add_rvalue_reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cpp/open-source-projects/index.html">C++ Open Source Projects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/gperftools.html">gperftools</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/gperftools.html#pprof">pprof</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/benchmark.html">Benchmark</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/benchmark.html#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/benchmark.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/onnxruntime.html">onnxruntime</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/onnxruntime.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/cereal.html">Cereal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/cereal.html#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/cereal.html#hello-world-example">Hello World Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/cereal.html#cereal-internals">Cereal Internals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/bazel.html">Bazel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpp/open-source-projects/libcxx.html">libc++</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/open-source-projects/libcxx.html#mutex">mutex</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cpp/cpp11/index.html">C++11</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cpp/cpp11/noexcept.html">noexcept</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../cpp/cpp11/noexcept.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../deep_learning/index.html">Deep Learning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../deep_learning/quantization.html">Quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../deep_learning/quantization.html#papers">Papers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">ARM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cross_toolchain.html">Cross Tool Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemu.html">Qemu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="qemu.html#install-from-apt-get">Install from <code class="docutils literal notranslate"><span class="pre">apt-get</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="qemu.html#install-from-source">Install from source</a></li>
<li class="toctree-l3"><a class="reference internal" href="qemu.html#hello-qemu">Hello Qemu</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">GCC Inline Assembly</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#move">move</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add">add</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="todo.html">TODO</a></li>
<li class="toctree-l2"><a class="reference internal" href="neon.html">NEON</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Programming Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">ARM</a> &raquo;</li>
        
      <li>GCC Inline Assembly</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/csu-fangjun/Programming-Notes/blob/master/arm/inline_assembly.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gcc-inline-assembly">
<h1>GCC Inline Assembly<a class="headerlink" href="#gcc-inline-assembly" title="Permalink to this headline">¶</a></h1>
<p>We can embed inline assembly inside a function. The syntax is as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">asm</span> <span class="nf">volatile</span><span class="p">(</span>
  <span class="s">&quot;instruction 1    </span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;instruction 2    </span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="o">:</span> <span class="c1">// output</span>
  <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">variable_name0</span><span class="p">),</span> <span class="c1">// %0</span>
  <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">variable_name1</span><span class="p">)</span>  <span class="c1">// %1</span>
  <span class="o">:</span> <span class="c1">// input</span>
  <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">variable_name2</span><span class="p">)</span>  <span class="c1">// %2</span>
  <span class="o">:</span> <span class="c1">// clobber list</span>
  <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;x0&quot;</span><span class="p">,</span> <span class="s">&quot;v0&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>For more details about the syntax, you can visit <a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</a>.</p>
<p>The following are some examples about inline assembly.</p>
<div class="section" id="move">
<h2>move<a class="headerlink" href="#move" title="Permalink to this headline">¶</a></h2>
<p>The following code is possibly the simplest inline assembly example
implementing <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">=</span> <span class="pre">a</span></code>. It demonstrates how to pass c variables to assembly
and to extract the output from assembly.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">asm</span> <span class="nf">volatile</span><span class="p">(</span><span class="s">&quot;mov %w0, %w1&quot;</span>
                 <span class="o">:</span>        <span class="c1">// output</span>
                 <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1">// %0</span>
                 <span class="o">:</span>        <span class="c1">// input</span>
                 <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>   <span class="c1">// %1</span>
                 <span class="o">:</span>        <span class="c1">// clobber list</span>
                 <span class="s">&quot;memory&quot;</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>The disassembler's output is:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span>0:   a9bd7bfd        stp     x29, x30, [sp,#-48]!
4:   910003fd        mov     x29, sp
8:   52800140        mov     w0, #0xa                        // #10
c:   b9002fa0        str     w0, [x29,#44]
10:  b9402fa0        ldr     w0, [x29,#44]
14:  2a0003e0        mov     w0, w0
18:  b9002ba0        str     w0, [x29,#40]
1c:  b9402fa1        ldr     w1, [x29,#44]
20:  b9402ba0        ldr     w0, [x29,#40]
24:  6b00003f        cmp     w1, w0
28:  54000140        b.eq    50 &lt;_ZN12_GLOBAL__N_19test_moveEv+0x50&gt;
</pre></div>
</td></tr></table></div>
<p>I've added some comment about it:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// NOTE: %0 is 64-bit, whereas %w0 is 32-bit</span>
<span class="c1">//       since int is 32-bit, so we use %w0</span>
<span class="c1">//</span>
<span class="c1">//  8: move an immediate value 10 to w0</span>
<span class="c1">//  c: save w0 to memory; address of variable a is x29 + 44</span>
<span class="c1">//  10: load a to w0; this is the `input` of the inline asm;</span>
<span class="c1">//      the compiler has assigned register w0 to the `input`</span>
<span class="c1">//  14: this is the inline asm `mov %w0, %w0`; the compiler</span>
<span class="c1">//      also assigns register w0 to the output</span>
<span class="c1">//  15: this is the inline asm for output;</span>
<span class="c1">//      address of variable b is x29 + 40</span>
<span class="c1">//  1c: now it comes the `assert` statement; load a into w1</span>
<span class="c1">//  20: load b into w0</span>
<span class="c1">//  24: compare w1 and w0</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>This is no need to use <code class="docutils literal notranslate"><span class="pre">#</span></code> to introduce an immediate value
in A64 assembly. For backward compatibility, it is not an error
to use <code class="docutils literal notranslate"><span class="pre">#</span></code> for immediate values.</p>
<p>The output of a disassembler will <strong>always</strong> use <code class="docutils literal notranslate"><span class="pre">#</span></code> for immediate values.</p>
</div>
<p>Another example for moving 64-bit integers:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="kt">int64_t</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x12345678deadbeef</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">asm</span> <span class="nf">volatile</span><span class="p">(</span>
        <span class="s">&quot;mov %0, %1     </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;add %0, %0, 1  </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1">// %0</span>
        <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>   <span class="c1">// %1</span>
        <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">b</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>The output of the disassembler is:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></div></td><td class="code"><div class="highlight"><pre><span></span>50:   d297dde0        mov     x0, #0xbeef                     // #48879
54:   f2bbd5a0        movk    x0, #0xdead, lsl #16
58:   f2cacf00        movk    x0, #0x5678, lsl #32
5c:   f2e24680        movk    x0, #0x1234, lsl #48
60:   f90013a0        str     x0, [x29,#32]
64:   f94013a0        ldr     x0, [x29,#32]
68:   aa0003e0        mov     x0, x0
6c:   91000400        add     x0, x0, #0x1
70:   f9000fa0        str     x0, [x29,#24]
74:   f94013a0        ldr     x0, [x29,#32]
78:   91000401        add     x1, x0, #0x1
7c:   f9400fa0        ldr     x0, [x29,#24]
80:   eb00003f        cmp     x1, x0
84:   54000140        b.eq    ac &lt;_ZN12_GLOBAL__N_19test_moveEv+0xac&gt;
</pre></div>
</td></tr></table></div>
<p>My note is:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// 50: x0[15:0] = 0xbeef</span>
<span class="c1">// 51: x0[31:16] = 0xdead</span>
<span class="c1">// 58: x0[47:32] = 0x5678</span>
<span class="c1">// 5c: x0[63:48] = 0x1234</span>
<span class="c1">// 60: save x0 to memory address x29 + 32 of variable a;</span>
<span class="c1">// 64: load a into x0; this is the inline asm for `input`;</span>
<span class="c1">//     the compiler has assigned x0 to the input variable</span>
<span class="c1">// 68: this is for inline asm `mov %0, %1`</span>
<span class="c1">//     the compiler has assigned x0 to the output variable</span>
<span class="c1">// 6c: this is for inline asm `add %0, %0, #1`</span>
<span class="c1">// 70: save x0 to the memory address x29 + 24 of variable b;</span>
<span class="c1">//     this is for the output variable of the inline asm</span>
<span class="c1">// 74: now it comes to assert ((a+1) == b)</span>
<span class="c1">//     load x29+32 to x0, i.e., load a into x0</span>
<span class="c1">// 78: x1 = x0 + 1 = a + 1</span>
<span class="c1">// 7c: load x29 + 24 into x0, i.e., load b into x0</span>
<span class="c1">// 80 compare x1 and x0, i.e., (a+1) and b</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add">
<h2>add<a class="headerlink" href="#add" title="Permalink to this headline">¶</a></h2>
<p>The following code show how to use <code class="docutils literal notranslate"><span class="pre">add</span></code>:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">asm</span> <span class="nf">volatile</span><span class="p">(</span>
        <span class="c1">// add 1 to a</span>
        <span class="s">&quot;add %w0, %w0, 1    </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="c1">// add 10 to b</span>
        <span class="s">&quot;add %w1, %w1, 10   </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="c1">// add 100 to c</span>
        <span class="s">&quot;add %w2, %w2, 100  </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="o">:</span>         <span class="c1">// output</span>
        <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>  <span class="c1">// %0</span>
        <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>  <span class="c1">// %1</span>
        <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>   <span class="c1">// %2</span>
        <span class="o">:</span>         <span class="c1">// input</span>
        <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>   <span class="c1">// 0 means using output operand %0</span>
        <span class="s">&quot;1&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>   <span class="c1">// 1 means using output operand %1</span>
        <span class="s">&quot;2&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>    <span class="c1">// 2 means using output operand %2</span>
        <span class="o">:</span>         <span class="c1">// clobber list</span>
        <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;x0&quot;</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">12</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">103</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The input operands use <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code> to refer
the operands from the output. The advantage is that we
can use less registers in the assembly. The drawback
is that it requires more <code class="docutils literal notranslate"><span class="pre">mov</span></code> instructions.</p>
<p>From the disassembler's output shown below, we can
see that the compiler allocates 4 registers instead of
3 or 6.</p>
</div>
<p>The output from the disassembler:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176</pre></div></td><td class="code"><div class="highlight"><pre><span></span>b4:   a9be7bfd        stp     x29, x30, [sp,#-32]!
b8:   910003fd        mov     x29, sp
bc:   52800020        mov     w0, #0x1                        // #1
c0:   b9001fa0        str     w0, [x29,#28]
c4:   52800040        mov     w0, #0x2                        // #2
c8:   b9001ba0        str     w0, [x29,#24]
cc:   52800060        mov     w0, #0x3                        // #3
d0:   b90017a0        str     w0, [x29,#20]
d4:   b9401fa2        ldr     w2, [x29,#28]
d8:   b9401ba1        ldr     w1, [x29,#24]
dc:   b94017a0        ldr     w0, [x29,#20]
e0:   2a0203e3        mov     w3, w2
e4:   2a0103e2        mov     w2, w1
e8:   2a0003e1        mov     w1, w0
ec:   11000463        add     w3, w3, #0x1
f0:   11002842        add     w2, w2, #0xa
f4:   11019021        add     w1, w1, #0x64
f8:   b9001fa3        str     w3, [x29,#28]
fc:   b9001ba2        str     w2, [x29,#24]
100:  b90017a1        str     w1, [x29,#20]
104:  b9401fa0        ldr     w0, [x29,#28]
108:  7100081f        cmp     w0, #0x2
</pre></div>
</td></tr></table></div>
<p>And my comment:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// bc: mov 1 to w0</span>
<span class="c1">// c0: save w0 to the memory address x29 + 28 of variable a</span>
<span class="c1">// c4: mov 2 to w0</span>
<span class="c1">// c8: save w0 to the memory address x29 + 24 of variable b</span>
<span class="c1">// cc: mov 3 to w0</span>
<span class="c1">// d0: save 20 to the memory address x29 + 20 of variable c</span>
<span class="c1">// d4: load memory x29 + 28, i.e., variable a into w2;</span>
<span class="c1">//     this is for inline asm; the compiler has assigned w2 to input 0</span>
<span class="c1">// d8: load memory x29 + 24, i.e., variable b into w1;</span>
<span class="c1">//     this is for inline asm; the compiler has assigned w1 to input 1</span>
<span class="c1">// dc: load memory x29 + 20, i.e., variable c into w0;</span>
<span class="c1">//     this is for inline asm; the compiler has assigned w0 to input 2</span>
<span class="c1">// e0: w3 = w2, the compiler has assigned w3 to output 0; this copies</span>
<span class="c1">//     the content from input 0 to output 0</span>
<span class="c1">// e4: w2 = w1, the compiler has assigned w2 to output 1; this copies</span>
<span class="c1">//     the content from input 1 to output 1</span>
<span class="c1">// e8: w1 = w0, the compiler has assigned w1 to output 3; this copies</span>
<span class="c1">//     the content from input 3 to output 3</span>
<span class="c1">//</span>
<span class="c1">// TODO(fangjun): why cannot input 0 and output 0 share the same register??</span>
<span class="c1">//</span>
<span class="c1">// ec: w3 = w3 + 1</span>
<span class="c1">// f0: w2 = w2 + 10</span>
<span class="c1">// f4: w1 = w1 + 100</span>
<span class="c1">//</span>
<span class="c1">// now save the result to the output variables</span>
<span class="c1">//</span>
<span class="c1">// f8:  save w3 to the memory address x29 + 28 of variable a</span>
<span class="c1">// fc:  save w2 to the memory address x29 + 24 of variable b</span>
<span class="c1">// 100: save w1 to the memory address x29 + 20 of variable c</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="todo.html" class="btn btn-neutral float-right" title="TODO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="qemu.html" class="btn btn-neutral float-left" title="Qemu" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, &lt;fangjun dot kuang at gmail dot com&gt;

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-160691436-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>