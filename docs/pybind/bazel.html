

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Build with Bazel &mdash; Programming Notes v0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Build with setup.py" href="setup.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Programming Notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../sphinx/index.html">Sphinx</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/install.html">Environment Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/rst_basics.html">reStructuredText Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/rst_basics.html#references">References</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/rst_basics.html#footnotes">Footnotes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx/exhale.html">Exhale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/exhale.html#install-exhale">Install Exhale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sphinx/exhale.html#configure-sphinx">Configure Sphinx</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/index.html">Secure Shell (SSH)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ssh/config.html">Passwordless Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#generate-keys">Generate keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#copy-keys">Copy Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssh/config.html#edit-ssh-config">Edit .ssh/config</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../ssh/config.html#configuration-for-git">Configuration for Git</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../os/index.html">Operating Systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../os/papers.html">Papers</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">pybind11</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Install pybind11</a></li>
<li class="toctree-l2"><a class="reference internal" href="make.html">Build with Make</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup.html">Build with setup.py</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Build with Bazel</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Programming Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">pybind11</a> &raquo;</li>
        
      <li>Build with Bazel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/csu-fangjun/Programming-Notes/blob/master/pybind/bazel.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="build-with-bazel">
<h1>Build with Bazel<a class="headerlink" href="#build-with-bazel" title="Permalink to this headline">¶</a></h1>
<p>As of today (2020-03-15), the latest bazel version
is <code class="docutils literal notranslate"><span class="pre">2.2.0</span></code>. Use the following commands to install it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://github.com/bazelbuild/bazel/releases/download/2.2.0/bazel-2.2.0-installer-linux-x86_64.sh
mkdir ~/software/bazel/2.2.0
chmod +x bazel-2.2.0-installer-linux-x86_64.sh
./bazel-2.2.0-installer-linux-x86_64.sh --prefix<span class="o">=</span><span class="nv">$HOME</span>/software/bazel/2.2.0
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/software/bazel/2.2.0/bin
<span class="nb">echo</span> <span class="s2">&quot;source </span><span class="nv">$HOME</span><span class="s2">/software/bazel/2.2.0/lib/bazel/bin/bazel-complete.bash&quot;</span> &gt;&gt; <span class="nv">$HOME</span>/.bashrc
</pre></div>
</div>
<p>After installation, <code class="docutils literal notranslate"><span class="pre">bazel</span> <span class="pre">version</span></code> should print the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Build</span> <span class="nl">label</span><span class="p">:</span> <span class="mf">2.2.0</span>
<span class="n">Build</span> <span class="nl">target</span><span class="p">:</span> <span class="n">bazel</span><span class="o">-</span><span class="n">out</span><span class="o">/</span><span class="n">k8</span><span class="o">-</span><span class="n">opt</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">google</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">bazel</span><span class="o">/</span><span class="n">BazelServer_deploy</span><span class="p">.</span><span class="n">jar</span>
<span class="n">Build</span> <span class="nl">time</span><span class="p">:</span> <span class="n">Tue</span> <span class="n">Mar</span> <span class="mi">3</span> <span class="mi">09</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">12</span> <span class="mi">2020</span> <span class="p">(</span><span class="mi">1583227572</span><span class="p">)</span>
<span class="n">Build</span> <span class="nl">timestamp</span><span class="p">:</span> <span class="mi">1583227572</span>
<span class="n">Build</span> <span class="n">timestamp</span> <span class="n">as</span> <span class="kt">int</span><span class="o">:</span> <span class="mi">1583227572</span>
</pre></div>
</div>
<p>To compile the following code,</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">hello.cc</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span> <span class="p">}</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;pybind11 hello world&quot;</span><span class="p">;</span>  <span class="c1">// optional module docstring</span>

  <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">,</span> <span class="s">&quot;A function which adds two numbers&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">WORKSPACE</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;</span><span class="p">,</span> <span class="s2">&quot;http_archive&quot;</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s2">&quot;:python_repo.bzl&quot;</span><span class="p">,</span> <span class="s2">&quot;python_repo&quot;</span><span class="p">)</span>

<span class="n">python_repo</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;python_headers&quot;</span><span class="p">,</span>
    <span class="n">python_interpreter</span> <span class="o">=</span> <span class="s2">&quot;python3&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">http_archive</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;pybind11&quot;</span><span class="p">,</span>
    <span class="n">build_file_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">package(default_visibility=[&quot;//visibility:public&quot;])</span>
<span class="s2">cc_library(</span>
<span class="s2">    name=&quot;pybind11&quot;,</span>
<span class="s2">    hdrs=glob([&quot;include/pybind11/*.h&quot;, &quot;include/pybind11/detail/*.h&quot;]),</span>
<span class="s2">    includes=[&quot;include&quot;],</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">sha256</span> <span class="o">=</span> <span class="s2">&quot;1eed57bc6863190e35637290f97a20c81cfe4d9090ac0a24f3bbf08f265eb71d&quot;</span><span class="p">,</span>
    <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s2">&quot;pybind11-2.4.3&quot;</span><span class="p">,</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://github.com/pybind/pybind11/archive/v2.4.3.tar.gz&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">.bazelrc</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="c1"># python3 is defined in py_runtime</span>
<span class="n">run</span> <span class="o">--</span><span class="n">python_top</span><span class="o">=//</span><span class="p">:</span><span class="n">python3</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">BUILD.tpl</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">package</span><span class="p">(</span><span class="n">default_visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;//visibility:public&quot;</span><span class="p">])</span>

<span class="n">cc_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;python_headers&quot;</span><span class="p">,</span>
    <span class="n">hdrs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;:python_include&quot;</span><span class="p">],</span>
    <span class="n">includes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;python_include&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="o">%</span><span class="p">{</span><span class="n">PYTHON_INCLUDE_GENRULE</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">python_repo.bzl</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># this file is modified from https://github.com/tensorflow/tensorflow/blob/master/third_party/py/python_configure.bzl</span>

<span class="c1"># Date: Sun Mar 15 20:50:01 CST 2020</span>

<span class="k">def</span> <span class="nf">_fail</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">red</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;31m&quot;</span>
    <span class="n">no_color</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Error:</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">no_color</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_which</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">program_name</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">execute</span><span class="p">([</span><span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="n">program_name</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">_get_python_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">python_interpreter</span><span class="p">):</span>
    <span class="n">python_bin</span> <span class="o">=</span> <span class="n">_which</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">python_interpreter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_bin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Cannot find python in PATH&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">python_bin</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_get_bash_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">):</span>
    <span class="n">bash_bin</span> <span class="o">=</span> <span class="n">_which</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bash_bin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Cannot find bash in PATH&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bash_bin</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_check_python_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;[[ -x &quot;</span><span class="si">{}</span><span class="s1">&quot; ]] &amp;&amp; [[ ! -d &quot;</span><span class="si">{}</span><span class="s1">&quot; ]]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">bash_bin</span> <span class="o">=</span> <span class="n">_get_bash_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">execute</span><span class="p">([</span><span class="n">bash_bin</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Invalid python path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_python_include</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">python_bin</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">python_bin</span><span class="p">,</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from __future__ import print_function;&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;from distutils import sysconfig;&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;print(sysconfig.get_python_inc())&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
        <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Failed to get Python include path&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_norm_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a path with &#39;/&#39; and remove the trailing slash.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_read_dir</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">src_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a sorted list with all files in a directory.</span>

<span class="sd">    Finds all files inside a directory, traversing subfolders and following</span>
<span class="sd">    symlinks.</span>

<span class="sd">    Args:</span>
<span class="sd">      repository_ctx: the repository_ctx</span>
<span class="sd">      src_dir: the directory to traverse</span>

<span class="sd">    Returns:</span>
<span class="sd">      A sorted list with all files in a directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">find_result</span> <span class="o">=</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">execute</span><span class="p">([</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">src_dir</span><span class="p">,</span> <span class="s2">&quot;-follow&quot;</span><span class="p">,</span> <span class="s2">&quot;-type&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">find_result</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Failed to get files form directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_dir</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">find_result</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">_genrule</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">genrule_name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">outs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string with a genrule.</span>

<span class="sd">    Genrule executes the given command and produces the given outputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;genrule(</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s1">&#39;    name = &quot;&#39;</span> <span class="o">+</span>
        <span class="n">genrule_name</span> <span class="o">+</span> <span class="s1">&#39;&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
        <span class="s2">&quot;    outs = [</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="n">outs</span> <span class="o">+</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    ],</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s1">&#39;    cmd = &quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
        <span class="n">command</span> <span class="o">+</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   &quot;&quot;&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
        <span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_symlink_genrule_for_dir</span><span class="p">(</span>
        <span class="n">repository_ctx</span><span class="p">,</span>
        <span class="n">src_dir</span><span class="p">,</span>
        <span class="n">dest_dir</span><span class="p">,</span>
        <span class="n">genrule_name</span><span class="p">):</span>
    <span class="n">src_dir</span> <span class="o">=</span> <span class="n">_norm_path</span><span class="p">(</span><span class="n">src_dir</span><span class="p">)</span>
    <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">_norm_path</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_read_dir</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">src_dir</span><span class="p">))</span>
    <span class="n">dest_files</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">src_files</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dest_files</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">dest_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># If we have only one file to link we do not want to use the dest_dir, as</span>
            <span class="c1"># $(@D) will include the full path to the file.</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="s2">&quot;$(@D)/&quot;</span> <span class="o">+</span> <span class="n">dest_dir</span> <span class="o">+</span> <span class="n">dest_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dest_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;$(@D)/&quot;</span> <span class="o">+</span> <span class="n">dest_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Copy the headers to create a sandboxable setup.</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cp -f&quot;</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="s1">&#39; &quot;</span><span class="si">{}</span><span class="s1">&quot; &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dest</span><span class="p">))</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        &quot;&#39;</span> <span class="o">+</span> <span class="n">dest_dir</span> <span class="o">+</span> <span class="n">dest_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&#39;</span><span class="p">)</span>
    <span class="n">genrule</span> <span class="o">=</span> <span class="n">_genrule</span><span class="p">(</span>
        <span class="n">src_dir</span><span class="p">,</span>
        <span class="n">genrule_name</span><span class="p">,</span>
        <span class="s2">&quot; &amp;&amp; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">genrule</span>

<span class="k">def</span> <span class="nf">_python_repo_impl</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">):</span>
    <span class="n">build_tpl</span> <span class="o">=</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">Label</span><span class="p">(</span><span class="s2">&quot;//:BUILD.tpl&quot;</span><span class="p">))</span>
    <span class="n">python_bin</span> <span class="o">=</span> <span class="n">_get_python_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">repository_ctx</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">python_interpreter</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">python_bin</span><span class="p">)</span>
    <span class="n">_check_python_bin</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">python_bin</span><span class="p">)</span>
    <span class="n">python_include</span> <span class="o">=</span> <span class="n">_get_python_include</span><span class="p">(</span><span class="n">repository_ctx</span><span class="p">,</span> <span class="n">python_bin</span><span class="p">)</span>
    <span class="n">python_include_rule</span> <span class="o">=</span> <span class="n">_symlink_genrule_for_dir</span><span class="p">(</span>
        <span class="n">repository_ctx</span><span class="p">,</span>
        <span class="n">python_include</span><span class="p">,</span>
        <span class="s2">&quot;python_include&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python_include&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">repository_ctx</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s2">&quot;BUILD&quot;</span><span class="p">,</span> <span class="n">build_tpl</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">&quot;%</span><span class="si">{PYTHON_INCLUDE_GENRULE}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">python_include_rule</span><span class="p">,</span>
    <span class="p">})</span>

<span class="n">python_repo</span> <span class="o">=</span> <span class="n">repository_rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_python_repo_impl</span><span class="p">,</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;python_interpreter&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;python3&quot;</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">BUILD.bazel</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">package</span><span class="p">(</span><span class="n">default_visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;//visibility:public&quot;</span><span class="p">])</span>

<span class="c1"># Note that the name has to be `hello.so`</span>
<span class="c1"># since the module name is `hello`.</span>
<span class="n">cc_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hello.so&quot;</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hello.cc&quot;</span><span class="p">],</span>
    <span class="n">linkshared</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">linkstatic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;@pybind11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@python_headers&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">py_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;test.py&quot;</span><span class="p">],</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hello.so&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">py_runtime</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;python3&quot;</span><span class="p">,</span>
    <span class="n">interpreter_path</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/python3&quot;</span><span class="p">,</span>
    <span class="n">files</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">test.py</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">hello</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hello</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="setup.html" class="btn btn-neutral float-left" title="Build with setup.py" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, &lt;fangjun dot kuang at gmail dot com&gt;

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-160691436-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>